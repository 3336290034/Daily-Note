# USB设备编程------内容补充

1，Pipe：usb通信的最基本形式是通过USB设备里面的endpoint，而主机和endpoint之间的数据传输就是通过pipe

- pipe中数据通信方式有两种，一种是`stream`一种是`message``message`要求进出进出方向必须要求同一个管道，默认就使用`ep0`作为`message`管道

2，Endpoint：端点是有方向的，主机到从机的是out端点，从机到主机的是in端点

- endpoint只能单向通信，要么是host->device，要么是devie->host（端点0除外）

## 逻辑设备

1，USB 逻辑设备必须建立在物理设备之上

- 逻辑设备就是一系列端点的组合，逻辑设备与主机之间的通信发生在一个主机的缓冲区和设备的一个端点之间（暂存疑）

2，逻辑设备是 “软件对硬件功能的细化”，但更准确说是 “协议层的功能划分”

```c
---------------------------
            host
---------------------------
   | buf | buf  |   buf |
---------------------------
    []      []      []
    []      []      []
    []      []      []------->pipe
    []      []      []
    []      []      []
---------------------------
{ |ep| }  {| ep|    |ep| }-->interface
---------------------------
        logic device
---------------------------

endpoint只能单向通信，要么是host->device，要么是devie->host(端点0除外)
而设备通信往往都是双向的，所以为了满足设备的功能，USB协议将多个管道组合到一起就形成了一个接口
```

- usb允许物理设备内置 “复合设备”（Composite Device），即一个物理硬件里封装 多个逻辑功能:
  - 手机连电脑：物理设备里可能同时存在 “存储接口”（传文件）、“串口接口”（调试）、“音频接口”（连耳机） 等多个逻辑设备
  - 有一个 USB 复合设备（比如带键盘和鼠标功能的扩展坞，物理设备），它内部会通过描述符告诉主机：“我包含两个逻辑设备 —— 键盘逻辑设备和鼠标逻辑设备”

- usb的`接口描述符`直接对应逻辑设备：每个`接口描述符`定义一个`逻辑功能`（如音频、存储、HID 等），包含该逻辑设备的端点、协议类型等信息
  - 物理设备通过`描述符`向主机暴露 “逻辑功能单元”（接口、端点），主机软件据此将硬件能力 分层拆分、独立管理（如复合设备的多功能拆分、单设备的多接口分工），实现 “软件定义硬件功能” 的效果
  - 主机枚举设备时，会读取这些描述符，从而 “感知” 物理设备内部的逻辑功能划分

- <https://www.doubao.com/thread/w7dfd024be7ae965d>

## Interface

1，一个逻辑设备可能包含若干个接口
2，每个接口表示一种功能内核里一个接口对应一个驱动程序例如usb扬声器就包含一个键盘接口和一个音频流接口
3，为什么需要接口Interface？

- 接口是最小的功能单元
- USB通信是双向的，而endpoint只能单向通信
- 所以为了满足要求（为了满足设备的功能），USB协议将多个管道组合到一起就形成了一个接口

## Function对应Interface

1，核心概念：USB接口（Interface） ≈ 功能（Function） ≈ 虚拟子设备

- `接口`是`功能`的载体，一个接口实现一个功能
- 使用usb实现某个功能，本质就是实现一个特定的接口，即实现一个特定的描述符
  - 是以「接口」为功能载体，通过「多层描述符体系」向主机声明能力，并配合硬件和协议栈完成实际数据交互。接口描述符是功能的核心声明，但需依赖其他描述符、硬件及协议逻辑共同实现
- <https://www.doubao.com/thread/wdea96e979b21ec28>

2，示例：通过`USB`实现虚拟串口

- 虚拟串口就是 USB 接口实现的 “串口功能”，多个虚拟串口对应多个接口（功能）
- “USB实现虚拟串口” 的本质，是`通过 USB 协议模拟串口功能`，而这个“模拟的串口”就是一个`接口（Interface）``对应的功能（Function）`：
  - 硬件：物理设备（如 MTK 设备、USB 转串口模块）内置 USB 控制器
  - 协议：使用`CDC（通信设备类，Communication Device Class）`协议 定义 “串口功能”
  - 接口：设备通过`接口描述符`告诉主机：“我有一个 CDC 功能（虚拟串口），支持收发数据”
  - 驱动：主机识别 CDC 接口后，加载串口驱动，将该接口映射为系统的 虚拟串口设备（如 Windows 的 COMx，Linux 的 /dev/ttyUSBx）
- <https://www.doubao.com/thread/w16c4086e6df46f74>
