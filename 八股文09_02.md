# 汇顶一面准备

## 为什么使用USB

- 根据我们的硬件方案，中控需要汇总多传感器数据并传输到上位机，同时接收上位机的配置指令，使用USB的核心优势在与高速传输和即插即用
  - 对比 RS485（仅用于中控向下连接传感器），USB 无需复杂的总线仲裁❓，且支持全双工通信，适合上位机与中控之间 “指令下发 - 数据回传” 的双向高频交互（如上位机周期性读取传感器状态、实时显示数据）❓
- 兼容 “供电 + 通讯” 一体化，简化工业场景布线
- 通过 USBX 实现虚拟串口，兼容传统串口协议并提升可靠性
  - 为什么要实现虚拟串口？如何实现的？❓❓❓
  1. 先引出USB`物理设备和逻辑设备`的区别
  2. USB物理设备是 USB 总线上的硬件实体（如 U 盘、键盘、复合设备等），包含电路、芯片、端点等硬件单元
  3. USB逻辑设备是 必须依赖物理设备存在的，是物理设备内部，通过描述符（接口、端点等） 向主机暴露的 “功能单元”
  4. 对于PC主机来说，物理设备是一个`黑盒`，他无法理解硬件的复杂结构，不知道硬件电路的作用；逻辑设备才是它能理解和控制的。所以PC主机软件需要读取物理设备的描符，将硬件能力翻译成`可管理的逻辑单元`
    就是接口Interface和端点Endpoint；PC主机软件会根据这些接口，将物理设别拆分成多个逻辑设备进行管理。从本质上来说是`软件上对硬件功能的细化`
  - 你说的USBX是什么？协议栈你是怎么理解的？❓
- USB通信是全双工、同步、差分 传输的

## 说说使用USB时，设备的访问流程

- 核心：Host 驱动负责总线，设备驱动负责设备逻辑
- 设备的访问流程大致如下：
  1. 应用程序通过系统调用请求访问USB设备
  2. Host驱动接收到请求后，进行设备枚举和初始化
  3. Host驱动与设备驱动进行通信，完成数据传输
  4. 设备驱动处理数据并返回结果给Host驱动
  5. Host驱动将结果返回给应用程序
- 如何识别USB设备？
- 如何确定有480Mbps的速率的？有几种速率模式？怎么区分的？❓总线驱动程序和设备驱动程序是不一样的
- USB Hub/root hub的作用是啥？

## USB是怎么传输数据的？

- 使用NRZI编码和位填充Bit-Stuffing技术
  1. 阐述NRZI编码的规则，为什么使用NRZI编码（使用价值在哪里）
  2. 位填充的规则，为什么使用位填充（使用价值在哪里）
  3. 二者协同的价值：NRZI 编码解决 “无时钟线的同步基础”，通过波形翻转传递时钟信息；位填充解决 “NRZI 编码的长串 1 缺陷”，确保所有数据场景下同步不丢失；

## USB传输的数据格式是怎样的？      ❓

- USB完整的数据传输需要涉及多个包：令牌包、数据包、握手包。这个完整的数据传输过程，被称为事务(Transaction)
  - 有4类事务、4类传输
- 数据包的格式包括：SOP（Start of Packet）、SYNC（同步信号）、PID（Packet ID）、Data（数据域）、CRC（循环冗余校验）、EOP（End of Packet）
  - 包的基本组成单元是域，有SYNC、PID核心基础域，有Data、CRC、EOP等其他域
- 数据包的传输过程分为：令牌阶段、数据阶段、握手阶段
- 是先传输最低位(LSB)还是最高位(MSB)？

## 描述符是啥，了解吗，有什么作用   ❓

- 描述符是USB设备的 `身份证`，用于向主机描述设备的属性和功能（核心点：描述信息）
  1. 身份证！统一信息格式：按 USB 协议规定字段，确保不同厂商的设备都能被主机识别
  2. 实现枚举配置：为主机提供 `识别设备→加载驱动→建立通信` 的全流程依据；
  3. 适配多样需求：通过分层描述（设备→配置→接口→端点），满足复杂设备的多功能、多模式需求；
  4. 保障通信稳定：明确传输细节（类型、数据包大小等），避免数据传输错误。
  5. 类似的思想在嵌入式其他领域也有应用。<https://www.doubao.com/thread/w34bd7818c4819d9f>
- USB设备的枚举过程是怎样的？
  - 主机主动读取描述符

## 你项目中用到的USBX组件，能说说该组件是什么吗？为什么要用它？你是怎么移植的？

- 先介绍USBX是什么，USBX的架构，最后再说为什么要用USBX，以及移植过程
  1. 首先，USBX是Azure RTOS生态下的嵌入式USB协议栈专为USB主机Host和USB设备Device通信设计，与Azure RTOS ThreadX实时操作系统紧密耦合，同时支持在独立模式（无 RTOS）下使用，是项目中实现 USB 功能（如虚拟串口、固件升级）的核心软件组件
  2. 在解释为什么使用他之前，先看看它的架构：
    USBX采用 3 层模块化架构：控制器层（Controller Layer）、协议栈层（Stack Layer）、设备类层（Class Layer）
     - 控制器层：对接硬件USB控制器，项目中直接复用STM32 HAL库驱动，无需手动开发底层寄存器操作
     - 协议栈层：实现USB协议核心逻辑，包括USB设备枚举、描述符管理、端点数据传输（如批量传输、中断传输），解决USB协议的底层细节（如MBAP报文头、CRC校验）
     - 设备类层：提供标准化的USB类接口，项目中重点使用 “CDC/ACM 类” 实现 USB 虚拟串口，用于中控与上位机的传感器数据传输、固件升级指令下发
    由此呢，可知知道：USBX能够有效地简化USB设备的开发和维护，提高开发效率。❓
  3. 为什么要用USBX？（这就是USBX三层架构的优势）
     - 统一的接口：USBX提供了一套统一的API接口，简化了USB设备的开发流程，降低了学习成本。
     - 高度模块化：USBX的三层架构使得各个功能模块相对独立，便于维护和扩展。
     - 良好的兼容性：USBX支持多种USB设备类型，能够满足不同项目的需求。
  4. 由前面讲述的 三层 架构可以知道，移植USBX，无非就是控制层、协议层、设备层；❓
     - 难点在于怎么初始化硬件以确保 Controller layer 可以正常运行
     - 怎么编写 APP：提供设备信息、传输数据
