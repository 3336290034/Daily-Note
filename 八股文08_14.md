# 堆和栈的区别？

1，维护者不同：

- 栈由程序来维护
- 堆由操作系统来维护

2，分配方式不同：

- 栈采用的是静态分配，大小在编译时确定
- 堆采用的是动态分配，大小在运行时确定
  - 堆的内存分配不受固定栈帧限制，可按需动态申请/释放
  - 堆的内存是动态分配、碎片化的

3，访问速度不同：

- 栈的访问速度快，因为栈内存是连续的，且由CPU直接管理，缓存命中率高
- 堆的访问速度慢，因为堆内存是动态分配的，可能会导致内存碎片，且引入链表（数据）结构缓存命中率低

4，数据组织方式不同：

- 栈是遵循FILO原则，后进先出，是以可预测的方式组织数据
- 堆是遵循随机访问原则，数据可以在内存中任意位置，不知道预测的

## 栈为何如此之快？

1，分配时：只需`移动栈指针`

- 栈是连续的内存空间，操作系统在线程创建时已预先分配固定大小（如 8MB）
- 栈的“空间有限”特性，决定了数据必须紧凑，而紧凑的数据提上来缓存命中的几率，也减小了内存浪费
- 只支持固定大小的数据类型
- 适用局部变量、临时小数据

2，释放时：`自动 “回退栈指针”`

## 堆为何如此之慢？

1，分配时：需要`搜索空闲块 + 可能触发系统调用`

- 可能触发系统调用：如果没有足够大的空闲块，就会调用系统调用从操作系统请求更多的内存
- 系统调用会导致 `“用户态→内核态”`的上下文切换，单次切换很耗时
- 适用动态大小数据、复杂数据结构

2, 释放时：需要`合并空闲块 + 维护链表`

- 维护链表可能需要维护有序性，该过程需要修改指针，遍历链表，同样有开销

## 堆和栈的配合

- 栈上存指针，通过指针访问堆的数据
- <https://www.doubao.com/thread/w0d429d2922705df4>
